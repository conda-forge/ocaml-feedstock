From: conda-forge
Subject: [PATCH] ocamlmklib: Support CONDA_OCAML_* environment variables

For cross-compilation in conda-forge, ocamlmklib needs to use TARGET
architecture tools instead of BUILD tools. The Config module values are
baked in at compile time and point to BUILD tools.

This patch adds support for CONDA_OCAML_AR and CONDA_OCAML_MKDLL
environment variables, falling back to Config values when not set.
This maintains backward compatibility while enabling cross-compilation.

Note: Config.mkexe is not used in ocamlmklib.ml, so no patch needed for it.
---
 tools/ocamlmklib.ml | 16 ++++++++++++++--
 1 file changed, 14 insertions(+), 2 deletions(-)

diff --git a/tools/ocamlmklib.ml b/tools/ocamlmklib.ml
--- a/tools/ocamlmklib.ml
+++ b/tools/ocamlmklib.ml
@@ -17,6 +17,18 @@

 open Printf

+(* conda-forge cross-compilation support:
+   Allow overriding Config values via environment variables.
+   This enables using TARGET tools instead of BUILD tools. *)
+let conda_ar =
+  match Sys.getenv_opt "CONDA_OCAML_AR" with
+  | Some v -> v
+  | None -> Config.ar
+let conda_mkdll =
+  match Sys.getenv_opt "CONDA_OCAML_MKDLL" with
+  | Some v -> v
+  | None -> Config.mkdll
+
 let mklib out files opts =
   if Config.ccomp_type = "msvc"
   then let machine =
@@ -25,7 +37,7 @@ let mklib out files opts =
       else ""
     in
     Printf.sprintf "link -lib -nologo %s-out:%s %s %s" machine out opts files
-  else Printf.sprintf "%s rcs %s %s %s" Config.ar out opts files
+  else Printf.sprintf "%s rcs %s %s %s" conda_ar out opts files

 (* PR#4783: under Windows, don't use absolute paths because we do
    not know where the binary distribution will be installed. *)
@@ -207,7 +219,7 @@ let build_libs () =
   if !c_objs <> [] then begin
     if !dynlink then begin
       let retcode = command
-          (Printf.sprintf "%s %s -o %s %s %s %s %s %s %s"
-             Config.mkdll
+          (Printf.sprintf "%s %s -o %s %s %s %s %s %s %s"
+             conda_mkdll
              (if !debug then "-g" else "")
              (prepostfix "dll" !output_c Config.ext_dll)
