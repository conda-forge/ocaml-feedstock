context:
  build_num: 0
  name: ocaml
  version: 5.4.0
  flexdll_version: 0.44
  dot: ${{ "./" if unix }}
  library: ${{ "Library/" if not unix }}
  m2: ${{ "m2-" if not unix }}
  sh: ${{ "sh" if unix else "bat" }}
  so: ${{ "so" if unix else "dll" }}
  xt: ${{ "" if unix else ".exe" }}
  # ===========================================================================
  # GCC-style derived values (not variant keys - keeps filenames clean)
  # TG_ comes from variants.yaml
  # ===========================================================================
  # Mirror variant value in context (needed for env var passthrough on Windows)
  pkg_target: ${{ TG_ }}
  # Derive triplet from TG_
  cross_target_triplet: >-
    ${{
      "x86_64-conda-linux-gnu"      if TG_ == "linux-64"                  else
      "aarch64-conda-linux-gnu"     if TG_ == "linux-aarch64"             else
      "powerpc64le-conda-linux-gnu" if TG_ == "linux-ppc64le"             else
      "x86_64-apple-darwin13.4.0"   if TG_ == "osx-64"                    else
      "arm64-apple-darwin20.0.0"    if TG_ == "osx-arm64"                 else
      "x86_64-w64-mingw32"          if TG_ == "win-64"                    else
      "unknown"
    }}
  # Which platform builds cross-compilers for each target
  cross_build_platform: >-
    ${{
      "linux-64" if TG_ in ["linux-64", "linux-aarch64", "linux-ppc64le"] else
      "osx-64"   if TG_ in ["osx-64", "osx-arm64"]                        else
      "win-64"   if TG_ == "win-64"                                       else
      target_platform
    }}
  # ===========================================================================
  # Build case detection helpers (exactly one is true per build)
  # ===========================================================================
  is_native: ${{ TG_ == build_platform }}
  is_cross_compiler: ${{ (TG_ != target_platform) and (build_platform == cross_build_platform) }}
  is_cross_target: ${{ (TG_ == target_platform) and (build_platform != target_platform) }}

recipe:
  name: ocaml-packages
  version: ${{ version }}

source:
  - url: https://github.com/ocaml/ocaml/archive/refs/tags/${{ version }}.tar.gz
    sha256: 4ab55ac30d247e20f35df20a9f7596e5eb5f92fbbd0f8e3e54838bbc3edf931e
  - if: win
    then:
      url: https://github.com/ocaml/flexdll/archive/refs/tags/${{ flexdll_version }}.tar.gz
      sha256: b7c6a92286f1f3065324d51083dcb16eec436a4e6e3b8df7cf836b6d7a8b9491
      target_directory: flexdll

build:
  number: ${{ build_num }}

outputs:
  # ==========================================================================
  # METAPACKAGE: ocaml
  # Depends on the platform-specific implementation ocaml_${{ TG_ }}
  # Only built when TG_ == target_platform (alongside native compiler)
  # ==========================================================================
  - package:
      name: ocaml
    build:
      skip: TG_ != target_platform
      noarch: generic
      script: echo "OCaml metapackage"
    requirements:
      run:
        - ${{ pin_subpackage("ocaml_" ~ TG_, exact=True) }}
      run_exports:
        - ${{ pin_subpackage("ocaml", upper_bound="x.x.x") }}
    tests:
      - script:
          - if: build_platform == target_platform
            then: ocaml -version
            else: echo "Skip on cross-compiled platform"

  # ==========================================================================
  # PLATFORM IMPLEMENTATION: ocaml_${{ TG_ }}
  #
  # Three mutually exclusive build cases (exactly one applies per build):
  #
  # 1. NATIVE (is_native): TG_ == build_platform
  #    Native compiler built on its own platform (e.g., linux-64 on linux-64)
  #
  # 2. CROSS-COMPILER (is_cross_compiler): TG_ != target_platform
  #    Cross-compiler built on designated platform (e.g., aarch64 cross on linux-64)
  #    Produces binaries that run on build platform, generate code for TG_
  #
  # 3. CROSS-TARGET (is_cross_target): TG_ == target_platform AND build != target
  #    Native compiler built via cross-compilation (e.g., aarch64 native built on linux-64)
  #    Produces native binaries for target platform
  # ==========================================================================
  - package:
      name: ocaml_${{ TG_ }}
    build:
      script:
        env:
          SKIP_MAKE_TESTS: "1"
          CROSS_TARGET_PLATFORM: ${{ pkg_target }}
          CROSS_TARGET_TRIPLET: ${{ cross_target_triplet }}
      skip: not (is_native or is_cross_compiler or is_cross_target)
      dynamic_linking:
        missing_dso_allowlist:
          - if: is_cross_compiler and aarch64
            then:
              - ld-linux-aarch64.${{ so }}.1
          - if: is_cross_compiler and ppc64le
            then:
              - ld64.${{ so }}.2
          - if: osx
            then:
              - /usr/lib/libSystem.B.dylib
          - if: not unix
            then:
              - C:/Windows/system32/SHLWAPI.dll
              - C:/Windows/system32/VERSION.dll
      prefix_detection:
        force_file_type:
          text:
            # --- NATIVE/CROSS-TARGET: Standard lib paths ---
            - if: is_native or is_cross_target
              then:
                - lib/ocaml/ld.conf
                - lib/ocaml/Makefile.config
                - lib/ocaml/runtime-launch-info

            # --- CROSS-COMPILER: Cross-compiler lib paths ---
            - if: is_cross_compiler
              then:
                - lib/ocaml-cross-compilers/*/lib/ocaml/ld.conf
                - lib/ocaml-cross-compilers/*/lib/ocaml/Makefile.config
                - lib/ocaml-cross-compilers/*/lib/ocaml/runtime-launch-info
        ignore:
          # --- NATIVE/CROSS-TARGET: Standard bytecode files ---
          - if: is_native or is_cross_target
            then:
              - bin/ocam{l,lcmt,lcp,ldebug,ldoc,lmklib,lmktop,loptp,lprof}
              - lib/ocaml/**/*.{cmo,cma,cmi,cmx,cmt,cmti}
              - bin/ocaml{c,dep,lex,objinfo,opt}.byte

          # --- CROSS-COMPILER: Cross-compiler bytecode files ---
          - if: is_cross_compiler
            then:
              - lib/ocaml-cross-compilers/*/lib/ocaml/**/*.{cmo,cma,cmi,cmx,cmt,cmti}
              - lib/ocaml-cross-compilers/*/bin/ocam{l,lcmt,lcp,ldebug,ldoc,lmklib,lmktop,loptp,lprof}
              - lib/ocaml-cross-compilers/*/bin/ocaml{c,dep,lex,objinfo,opt}.byte

    # ========================================================================
    # REQUIREMENTS
    # ========================================================================
    requirements:
      build:
        # --- Common build deps (all cases) ---
        - ${{ compiler('c') }}
        - ${{ stdlib('c') }}
        - ${{ m2 }}bash >=5.2
        - ${{ m2 }}file
        - ${{ m2 }}findutils
        - ${{ m2 }}gawk
        - ${{ m2 }}grep
        - ${{ m2 }}make
        - ${{ m2 }}sed
        - ${{ m2 }}tar
        - binutils

        # --- CROSS-COMPILER: Target platform toolchain ---
        # Guard (TG_ != build_platform) prevents self-referential cycle detection
        - if: is_cross_compiler and (linux or osx) and (TG_ != build_platform)
          then:
            - if: match(version, ">=5.4.0") and (build_num > 1)
              then:
                - ocaml_${{ build_platform }} >=5.4
            - if: linux
              then:
                - ${{ c_compiler }}_impl_${{ TG_ }} ${{ c_compiler_version }}*
                - sysroot_${{ TG_ }}
                - binutils_impl_${{ TG_ }}
              else:
                - ${{ c_compiler }}_impl_${{ TG_ }} ${{ c_compiler_version }}*

        # --- CROSS-TARGET: Bootstrap compiler for cross-compilation ---
        - if: is_cross_target
          then:
            - zstd
            - if: match(version, ">=5.4.0") and (build_num > 1)
              then:
                - ocaml_${{ target_platform }} >=5.4

        # --- non-unix-specific ---
        - if: not unix
          then:
            - ${{ m2 }}coreutils
            - ${{ m2 }}diffutils
            - ${{ m2 }}which

        # --- OSX-specific ---
        - if: osx
          then:
            - lld ${{ c_compiler_version }}*
            - llvm-tools ${{ c_compiler_version }}*

      host:
        - zstd

      run:
        - zstd
        - if: not unix
          then:
            - binutils_impl_${{ TG_ }}

        # --- CROSS-COMPILER: C toolchain for target platform ---
        - if: is_cross_compiler and (linux or osx)
          then:
            - if: linux
              then:
                - gcc_impl_${{ TG_ }}
                - binutils_impl_${{ TG_ }}
              else:
                - clang_impl_${{ TG_ }}
                - llvm-tools
                - lld

    # ========================================================================
    # TESTS
    # ========================================================================
    tests:
      # ----------------------------------------------------------------------
      # Package contents verification
      # ----------------------------------------------------------------------
      - package_contents:
          strict: true
          bin:
            # NATIVE: Full native toolset
            - if: is_native
              then:
                - conda-ocaml-{ar,as,cc,ld,mkdll,mkexe,ranlib}
                - ocaml
                - ocaml{c,dep,lex,objinfo,opt,mklib,yacc}
                - ocaml{c,dep,lex,objinfo,opt,mklib,yacc}.opt
                - ocaml{c,dep,lex,objinfo,opt}.byte
                - ocaml{cmt,cp,debug,doc,doc.opt,mktop,optp,prof,run,rund}
                - if: unix
                  then:
                    - ocamlruni
                  else:
                    - flexlink
                    - flexlink.byte
                    - flexlink.opt
                    - windres
                    - conda-ocaml-windres

            # CROSS-TARGET: Native toolset (no ocamldebug/ocamldoc)
            - if: is_cross_target
              then:
                - conda-ocaml-{ar,as,cc,ld,mkdll,mkexe,ranlib}
                - ocaml
                - ocaml{c,dep,lex,objinfo,opt,mklib,yacc}
                - ocaml{c,dep,lex,objinfo,opt,mklib,yacc}.opt
                - ocaml{c,dep,lex,objinfo,opt}.byte
                - ocaml{cmt,cp,mktop,optp,prof,run,rund}
                - if: unix
                  then:
                    - ocamlruni

            # CROSS-COMPILER: Prefixed cross tools
            - if: is_cross_compiler
              then:
                - ${{ cross_target_triplet }}-ocaml{c,dep,lex,objinfo,opt,mklib,yacc}
                - ${{ cross_target_triplet }}-ocaml{c,dep,lex,objinfo,opt,mklib,yacc}.opt
                - ${{ cross_target_triplet }}-ocaml-{ar,as,cc,ld,mkdll,mkexe,ranlib}

          files:
            - etc/conda/test-files/*

            # NATIVE/CROSS-TARGET: Standard layout
            - if: is_native or is_cross_target
              then:
                - etc/conda/activate.d/ocaml_activate.${{ sh }}
                - etc/conda/deactivate.d/ocaml_deactivate.${{ sh }}
                - ${{ library }}lib/ocaml/expunge${{ xt }}
                - ${{ library }}lib/ocaml/ld.conf
                - ${{ library }}lib/ocaml/libasmrun.a
                - ${{ library }}lib/ocaml/Makefile.config
                - ${{ library }}lib/ocaml/runtime-launch-info
                - ${{ library }}lib/ocaml/sys.ml.in
                - ${{ library }}lib/ocaml/*.{a,cma,cmi,cmo,cmt,cmti,cmx,cmxa,ml,mli,o}
                - ${{ library }}lib/ocaml/caml/domain_state.tbl
                - ${{ library }}lib/ocaml/caml/*.h
                - ${{ library }}lib/ocaml/{compiler-libs,dynlink,profiling,runtime_events,stdlib,str,threads,unix}/*
                - ${{ library }}lib/ocaml/stublibs/dll*.${{ so }}
                - ${{ library }}share/doc/ocaml/*
                - ${{ library }}share/man/man{1,3}/*
                - if: unix
                  then:
                    - ${{ library }}lib/ocaml/libasmrun_shared.so
                    - ${{ library }}lib/ocaml/libcamlrun_shared.so

            # NATIVE: Also includes ocamldoc directory
            - if: is_native
              then:
                - ${{ library }}lib/ocaml/ocamldoc/*

            # CROSS-COMPILER: Cross-compiler layout
            - if: is_cross_compiler
              then:
                - lib/ocaml-cross-compilers/${{ cross_target_triplet }}/bin/ocaml{c,dep,lex,objinfo,opt,mklib,yacc}
                - lib/ocaml-cross-compilers/${{ cross_target_triplet }}/bin/ocaml{c,dep,lex,objinfo,opt}.opt
                - lib/ocaml-cross-compilers/${{ cross_target_triplet }}/lib/ocaml/expunge${{ xt }}
                - lib/ocaml-cross-compilers/${{ cross_target_triplet }}/lib/ocaml/ld.conf
                - lib/ocaml-cross-compilers/${{ cross_target_triplet }}/lib/ocaml/libasmrun.a
                - lib/ocaml-cross-compilers/${{ cross_target_triplet }}/lib/ocaml/libasmrun_shared.so
                - lib/ocaml-cross-compilers/${{ cross_target_triplet }}/lib/ocaml/libcamlrun_shared.so
                - lib/ocaml-cross-compilers/${{ cross_target_triplet }}/lib/ocaml/Makefile.config
                - lib/ocaml-cross-compilers/${{ cross_target_triplet }}/lib/ocaml/runtime-launch-info
                - lib/ocaml-cross-compilers/${{ cross_target_triplet }}/lib/ocaml/sys.ml.in
                - lib/ocaml-cross-compilers/${{ cross_target_triplet }}/lib/ocaml/*.{a,cma,cmi,cmo,cmt,cmti,cmx,cmxa,ml,mli,o}
                - lib/ocaml-cross-compilers/${{ cross_target_triplet }}/lib/ocaml/caml/domain_state.tbl
                - lib/ocaml-cross-compilers/${{ cross_target_triplet }}/lib/ocaml/caml/*.h
                - lib/ocaml-cross-compilers/${{ cross_target_triplet }}/lib/ocaml/{compiler-libs,dynlink,profiling,runtime_events,stdlib,str,threads,unix}/*
                - lib/ocaml-cross-compilers/${{ cross_target_triplet }}/lib/ocaml/stublibs/dll*.${{ so }}
                - lib/ocaml-cross-compilers/${{ cross_target_triplet }}/share/doc/ocaml/*
                - lib/ocaml-cross-compilers/${{ cross_target_triplet }}/share/man/man1/*

      # ----------------------------------------------------------------------
      # NATIVE: Environment and resource file path validation
      # ----------------------------------------------------------------------
      - script:
          - if: is_native and unix
            then: cd testing && ${{ dot }}test-env-paths.${{ sh }}
            else: echo "Skipping env path tests"
        files:
          recipe:
            - testing/test-env-paths.${{ sh }}
        requirements:
          run:
            - binutils
            - if: not arm64
              then:
                - ${{ m2 }}grep

      # ----------------------------------------------------------------------
      # NATIVE: OCAML config validation
      # ----------------------------------------------------------------------
      - script:
          - if: is_native and unix and not arm64
            then: cd testing && ./test-config.sh
            else: echo "Skipping config tests"
        files:
          recipe:
            - testing/test-config.sh
        requirements:
          run:
            - ${{ m2 }}file
            - if: is_native
              then:
                - binutils_impl_${{ target_platform }}
            - if: not arm64
              then:
                - ${{ m2 }}grep

      # ----------------------------------------------------------------------
      # CROSS-TARGET: Cross-compiled binary architecture verification
      # ----------------------------------------------------------------------
      - script:
          - if: is_cross_target
            then: cd testing && ${{ dot }}test-cross-arch.${{ sh }} ${{ target_platform }}
            else: echo "Native build or cross-compiler - skipping cross-arch check"
        files:
          recipe:
            - testing/test-cross-arch.${{ sh }}
        requirements:
          run:
            - binutils

      # ----------------------------------------------------------------------
      # NATIVE: Tool version checks
      # ----------------------------------------------------------------------
      - script:
          - if: is_native and not arm64
            then: cd testing && ${{ dot }}test-tool-versions.${{ sh }} ${{ version }}
            else: echo "Skipping tool version tests"
        files:
          recipe:
            - testing/test-tool-versions.${{ sh }}
        requirements:
          run:
            - ${{ m2 }}grep

      # ----------------------------------------------------------------------
      # NATIVE: Native-only tools test (ocamldoc, ocamldebug)
      # ----------------------------------------------------------------------
      - script:
          - if: is_native and unix
            then: cd testing && ${{ dot }}test-native-only-tools.${{ sh }} ${{ version }}
            else: echo "Skipping native-only tools"
        files:
          recipe:
            - testing/test-native-only-tools.${{ sh }}
        requirements:
          run:
            - ${{ m2 }}grep

      # ----------------------------------------------------------------------
      # NATIVE: Compilation tests
      # ----------------------------------------------------------------------
      - script:
          - if: is_native
            then: cd testing && ${{ dot }}test-compilation.${{ sh }} ${{ version }}
            else: echo "Skipping compilation tests"
        files:
          recipe:
            - testing/test-compilation.${{ sh }}
        requirements:
          run:
            - ${{ c_compiler }}_impl_${{ target_platform }} >=${{ c_compiler_version }}
            - ${{ m2 }}file
            - ${{ m2 }}grep
            - if: osx
              then:
                - lld >=${{ c_compiler_version }}
                - llvm-tools >=${{ c_compiler_version }}

      # ----------------------------------------------------------------------
      # NATIVE: CONDA_OCAML_* toolchain variable tests
      # ----------------------------------------------------------------------
      - script:
          - if: is_native
            then: cd testing && ${{ dot }}test-toolchain-vars.${{ sh }}
            else: echo "Toolchain var tests only on native builds"
        files:
          recipe:
            - testing/test-toolchain-vars.${{ sh }}
        requirements:
          run:
            - ${{ c_compiler }}_impl_${{ target_platform }} >=${{ c_compiler_version }}
            - ${{ m2 }}grep
            - if: osx
              then:
                - lld >=${{ c_compiler_version }}
                - llvm-tools >=${{ c_compiler_version }}

      # ----------------------------------------------------------------------
      # CROSS-COMPILER: Functional tests
      # ----------------------------------------------------------------------
      - script:
          - if: is_cross_compiler
            then: |
              cd testing
              ./test-cross-compilers.sh ${{ version }} ${{ build_platform }} ${{ target_platform }} ${{ cross_target_triplet }}
            else: echo "Not a cross-compiler package"
        files:
          recipe:
            - testing/test-cross-compilers.sh
        requirements:
          run:
            - ${{ m2 }}file

  # ==========================================================================
  # TOOLCHAIN META-PACKAGE: ocaml-compiler
  # Convenience package that bundles OCaml with C compiler
  # Only built when TG_ == target_platform (alongside native compiler)
  # ==========================================================================
  - package:
      name: ocaml-compiler
    build:
      skip: TG_ != target_platform
      noarch: generic
      script: echo "Toolchain meta-package"
    requirements:
      run:
        - ${{ pin_subpackage('ocaml', exact=True) }}
        - ${{ compiler('c') }}
    tests:
      - script: echo "ocaml-compiler toolchain meta-package installed"

about:
  homepage: https://ocaml.org/
  license: LGPL-2.1-only WITH OCaml-LGPL-linking-exception
  license_family: LGPL
  license_file: LICENSE
  summary: Objective Caml (OCaml) is an implementation of the ML language.
  description: |
    OCaml is an implementation of the ML language, based on the Caml Light
    dialect extended with a complete class-based object system and a powerful
    module system in the style of Standard ML.

    OCaml comprises two compilers. One generates bytecode which is then
    interpreted by a C program. This compiler runs quickly, generates compact
    code with moderate memory requirements, and is portable to essentially any
    32 or 64 bit Unix platform. Performance of generated programs is quite good
    for a bytecoded implementation.  This compiler can be used either as a
    standalone, batch-oriented compiler that produces standalone programs, or as
    an interactive, toplevel-based system.

    The other compiler generates high-performance native code for a number of
    processors. Compilation takes longer and generates bigger code, but the
    generated programs deliver excellent performance, while retaining the
    moderate memory requirements of the bytecode compiler.
  documentation: https://ocaml.org/docs/
  repository: https://github.com/ocaml/ocaml

extra:
  recipe-maintainers:
    - isuruf
    - dslarm
    - MementoRC
